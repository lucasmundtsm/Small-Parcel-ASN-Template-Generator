<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASN Upload Generator - Improved Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #001f4d 0%, #003d7a 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #001f4d;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        
        .upload-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .upload-section.uploaded {
            background: #e8f5e9;
            border-color: #4caf50;
        }
        
        .upload-section h3 {
            margin-top: 0;
            color: #001f4d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .file-info.success {
            color: #4caf50;
            font-weight: bold;
        }
        
        .process-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #001f4d 0%, #003d7a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 31, 77, 0.3);
        }
        
        .process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.success {
            background: #c8e6c9;
            color: #2e7d32;
        }
        
        .status.error {
            background: #ffcdd2;
            color: #c62828;
        }
        
        .status.processing {
            background: #fff3e0;
            color: #e65100;
        }
        
        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 10px;
            border: 2px solid #1976d2;
        }
        
        .result-section h3 {
            color: #1976d2;
            margin-top: 0;
        }
        
        .download-btn {
            padding: 12px 24px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        
        .download-btn:hover {
            background: #45a049;
        }
        
        textarea {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .check-icon {
            color: #4caf50;
            font-size: 20px;
        }
        
        .instructions {
            background: #fffbf0;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #f57c00;
            margin-top: 0;
        }
        
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ ASN Upload Generator</h1>
        <p class="subtitle">Automated Tracking Number Import for Amazon Vendor Central</p>
        
        <div class="instructions">
            <h3>üìã Instructions</h3>
            <ol>
                <li>Upload your Excel file containing ARN and PO mapping (SP_ASN_Test.xlsx or similar)</li>
                <li>Upload your ASN template CSV file (ASNWebsheetTemplate.csv)</li>
                <li>Upload the PDF label file(s) containing tracking numbers</li>
                <li>Click "Process Files" to automatically match and populate tracking numbers</li>
                <li>Download the completed ASN file for upload to Amazon Vendor Central</li>
            </ol>
        </div>
        
        <div class="upload-section" id="excelSection">
            <h3>üìä 1. Upload Excel File (ARN-PO Mapping)</h3>
            <input type="file" id="excelFile" class="file-input" accept=".xlsx,.xls" />
            <div class="file-info" id="excelInfo">No file selected</div>
        </div>
        
        <div class="upload-section" id="csvSection">
            <h3>üìÑ 2. Upload ASN Template CSV</h3>
            <input type="file" id="csvFile" class="file-input" accept=".csv" />
            <div class="file-info" id="csvInfo">No file selected</div>
        </div>
        
        <div class="upload-section" id="pdfSection">
            <h3>üè∑Ô∏è 3. Upload PDF Label File(s)</h3>
            <input type="file" id="pdfFiles" class="file-input" accept=".pdf" multiple />
            <div class="file-info" id="pdfInfo">No files selected</div>
        </div>
        
        <button class="process-btn" id="processBtn" onclick="processFiles()" disabled>
            ‚ö° Process Files
        </button>
        
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
        
        <div id="status"></div>
        <div id="results"></div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let excelData = null;
        let csvData = null;
        let pdfData = [];

        // File input event listeners
        document.getElementById('excelFile').addEventListener('change', handleExcelFile);
        document.getElementById('csvFile').addEventListener('change', handleCSVFile);
        document.getElementById('pdfFiles').addEventListener('change', handlePDFFiles);

        function updateProgress(percent, text = '') {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (percent > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
                progressFill.textContent = text || percent + '%';
            } else {
                progressBar.style.display = 'none';
            }
        }

        function showStatus(message, type = 'processing') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet);
                
                // Store Excel data with ARN-PO mapping
                excelData = {};
                const uniqueARNs = new Set();
                
                data.forEach(row => {
                    const arn = String(row.ARN || '').trim();
                    const po = String(row['Order/PO Number'] || '').trim();
                    
                    if (arn && po) {
                        if (!excelData[arn]) {
                            excelData[arn] = [];
                        }
                        excelData[arn].push(po);
                        uniqueARNs.add(arn);
                    }
                });
                
                document.getElementById('excelInfo').textContent = 
                    `‚úÖ Loaded ${uniqueARNs.size} unique ARNs with PO mappings`;
                document.getElementById('excelInfo').className = 'file-info success';
                document.getElementById('excelSection').className = 'upload-section uploaded';
                
                checkReadyToProcess();
            } catch (error) {
                showStatus('Error reading Excel file: ' + error.message, 'error');
            }
        }

        async function handleCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const parsed = Papa.parse(text, { 
                    header: true, 
                    dynamicTyping: true,
                    skipEmptyLines: true
                });
                
                csvData = {
                    filename: file.name,
                    data: parsed.data,
                    headers: parsed.meta.fields
                };
                
                // Count rows by PO
                const poCount = {};
                csvData.data.forEach(row => {
                    const po = row.PO;
                    if (po) {
                        poCount[po] = (poCount[po] || 0) + 1;
                    }
                });
                
                const totalRows = Object.values(poCount).reduce((a, b) => a + b, 0);
                
                document.getElementById('csvInfo').textContent = 
                    `‚úÖ Loaded ${totalRows} rows across ${Object.keys(poCount).length} POs`;
                document.getElementById('csvInfo').className = 'file-info success';
                document.getElementById('csvSection').className = 'upload-section uploaded';
                
                checkReadyToProcess();
            } catch (error) {
                showStatus('Error reading CSV file: ' + error.message, 'error');
            }
        }

        async function handlePDFFiles(event) {
            const files = Array.from(event.target.files);
            pdfData = [];
            
            showStatus('Processing PDF files...', 'processing');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress(Math.round((i / files.length) * 100), `Processing PDF ${i + 1}/${files.length}`);
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    
                    const trackingIds = [];
                    
                    // Extract tracking IDs from all pages
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const text = textContent.items.map(item => item.str).join(' ');
                        
                        // Extract UPS tracking numbers
                        const upsPattern = /1Z[A-Z0-9]{16,18}/g;
                        const matches = text.match(upsPattern);
                        if (matches) {
                            trackingIds.push(...matches);
                        }
                    }
                    
                    // Extract ARN from filename
                    const arnMatch = file.name.match(/\d{10,12}/);
                    const arn = arnMatch ? arnMatch[0] : null;
                    
                    // Remove duplicates
                    const uniqueTrackingIds = [...new Set(trackingIds)];
                    
                    pdfData.push({
                        filename: file.name,
                        trackingIds: uniqueTrackingIds,
                        arn: arn
                    });
                    
                } catch (error) {
                    showStatus(`Error reading PDF file ${file.name}: ${error.message}`, 'error');
                    return;
                }
            }
            
            const totalTracking = pdfData.reduce((sum, pdf) => sum + pdf.trackingIds.length, 0);
            
            document.getElementById('pdfInfo').textContent = 
                `‚úÖ Loaded ${pdfData.length} PDF(s) with ${totalTracking} tracking numbers`;
            document.getElementById('pdfInfo').className = 'file-info success';
            document.getElementById('pdfSection').className = 'upload-section uploaded';
            
            updateProgress(0);
            showStatus('PDF files processed successfully!', 'success');
            setTimeout(() => document.getElementById('status').style.display = 'none', 3000);
            
            checkReadyToProcess();
        }

        function checkReadyToProcess() {
            const btn = document.getElementById('processBtn');
            btn.disabled = !(excelData && csvData && pdfData.length > 0);
        }

        function processFiles() {
            if (!excelData || !csvData || pdfData.length === 0) {
                showStatus('Please upload all required files first!', 'error');
                return;
            }

            showStatus('Processing files...', 'processing');
            updateProgress(10, 'Matching ARNs and POs...');

            try {
                const results = [];
                
                // Process each PDF
                pdfData.forEach((pdf, pdfIndex) => {
                    updateProgress(20 + (pdfIndex / pdfData.length) * 60, `Processing ${pdf.filename}...`);
                    
                    if (!pdf.arn) {
                        console.warn(`No ARN found in filename: ${pdf.filename}`);
                        return;
                    }
                    
                    // Get POs for this ARN
                    const posForARN = excelData[pdf.arn];
                    if (!posForARN) {
                        console.warn(`No POs found for ARN: ${pdf.arn}`);
                        return;
                    }
                    
                    // Get unique POs (remove duplicates)
                    const uniquePOs = [...new Set(posForARN)];
                    
                    // Filter CSV rows for these POs
                    const relevantRows = csvData.data.filter(row => uniquePOs.includes(row.PO));
                    
                    if (relevantRows.length === 0) {
                        console.warn(`No matching rows in CSV for POs: ${uniquePOs.join(', ')}`);
                        return;
                    }
                    
                    // Create output data
                    const outputRows = [];
                    let trackingIndex = 0;
                    
                    relevantRows.forEach(row => {
                        const newRow = { ...row };
                        if (trackingIndex < pdf.trackingIds.length) {
                            newRow['Carrier tracking number'] = pdf.trackingIds[trackingIndex];
                            trackingIndex++;
                        }
                        outputRows.push(newRow);
                    });
                    
                    results.push({
                        arn: pdf.arn,
                        pos: uniquePOs,
                        filename: `ASN_${pdf.arn}_ready.csv`,
                        data: outputRows,
                        trackingUsed: trackingIndex,
                        trackingTotal: pdf.trackingIds.length,
                        rowsProcessed: outputRows.length
                    });
                });
                
                updateProgress(90, 'Generating output files...');
                
                // Display results
                displayResults(results);
                
                updateProgress(100, 'Complete!');
                showStatus(`Successfully processed ${results.length} ARN group(s)!`, 'success');
                
                setTimeout(() => updateProgress(0), 2000);
                
            } catch (error) {
                showStatus('Error processing files: ' + error.message, 'error');
                console.error(error);
            }
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="result-section"><h3>‚ö†Ô∏è No matching data found</h3><p>Please verify that the ARNs in your PDF filenames match those in the Excel file.</p></div>';
                return;
            }
            
            let html = '';
            
            results.forEach((result, index) => {
                const csvContent = Papa.unparse(result.data, {
                    quotes: true,
                    delimiter: ',',
                    header: true
                });
                
                html += `
                    <div class="result-section">
                        <h3>‚úÖ ARN: ${result.arn}</h3>
                        <p><strong>POs:</strong> ${result.pos.join(', ')}</p>
                        <p><strong>Rows processed:</strong> ${result.rowsProcessed}</p>
                        <p><strong>Tracking numbers used:</strong> ${result.trackingUsed} of ${result.trackingTotal}</p>
                        <button class="download-btn" onclick="downloadCSV('${result.filename}', ${index})">
                            üíæ Download ${result.filename}
                        </button>
                        <button class="download-btn" onclick="copyToClipboard(${index})">
                            üìã Copy to Clipboard
                        </button>
                        <textarea id="csv_${index}" readonly>${csvContent}</textarea>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            
            // Store results globally for download functions
            window.processedResults = results;
        }

        function downloadCSV(filename, index) {
            const result = window.processedResults[index];
            const csvContent = Papa.unparse(result.data, {
                quotes: true,
                delimiter: ',',
                header: true
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`Downloaded ${filename}`, 'success');
        }

        function copyToClipboard(index) {
            const textarea = document.getElementById(`csv_${index}`);
            textarea.select();
            document.execCommand('copy');
            
            // Fallback for modern browsers
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textarea.value).then(() => {
                    showStatus('Copied to clipboard!', 'success');
                });
            } else {
                showStatus('Copied to clipboard!', 'success');
            }
        }
    </script>
</body>
</html>
